<html>
<header>
  <title>barnsley fern</title>
  <script src="https://cdn.jsdelivr.net/npm/p5@latest/lib/p5.min.js"></script>
<style>
* { box-sizing: border-box; }
body {
  margin: 0;
  padding: 0;
  width: 100vw;
  height: 100%;
  overflow: hidden;
  color: lightgray;
  font-size: 12px;
  font-family: monospace;
}
main {
  width: 100%;
  height: 100%;
}
aside {
  position: fixed;
  inset: auto 0 0 0;
  background-color: rgb(from gray r g b / .5);
  padding: 10px;
}
</style>
</header>
<body>
  <main>
    <!-- <canvas></canvas> -->
  </main>
  <aside>
    <button onclick="isLooping() ? noLoop() : loop()">start / stop</button>
    <button onclick="setup()">clear</button>
    <span id="pos"></span>
    <details open>
      <summary>more</summary>
      <span id="info"></span>
    </details>
  </aside>
<script>
const affine = ([x, y], [[a, b], [c, d]], [e, f]) => [a*x + b*y + e, c*x + d*y + f]
const params = [
  [ 0   ,  0   ,  0   , 0.16, 0, 0   ], // シダの茎
  [ 0.85,  0.04, -0.04, 0.85, 0, 1.60], // 連続する小さい葉
  [ 0.20, -0.26,  0.23, 0.22, 0, 1.60], // 左側の大きな葉
  [-0.15,  0.28,  0.26, 0.24, 0, 0.44], // 右側の大きな葉
]
const probs = [0.01, 0.85, 0.07, 0.07]
const updatePosition = (x, y) => {
  let r = random()
  let [, i] = probs.reduce(([cumProb, result], p, i) => {
    if (cumProb <= r && r < cumProb + p) { result = i }
    return [cumProb + p, result]
  }, [0, -1])
  let [a,b,c,d,e,f] = params[i]
  let [nextX, nextY] = affine([x, y], [[a, b], [c, d]], [e, f])
  return [nextX, nextY]
}

let x = 0, y = 0
let xmn = 0, xmx = 0, ymn = 0, ymx = 0 // for debug

function setup() {
  createCanvas(windowWidth, windowHeight)
  // createCanvas(100, 100, document.querySelector('canvas'))
  frameRate(10)
  background(33)

  if (0) {
    translate(width / 2, height / 2)
    scale(1, -1)
    stroke(255, 0, 0, 50)
    for (let x = 0; x < width; x += 50) { line(x, 0, x, height) }
  }

  stroke(0, 255, 0)
  // stroke(0, 255, 0, 50)
  // strokeWeight(4)

  x = 0, y = 0
  xmn = 0, xmx = 0, ymn = 0, ymx = 0
}

function draw() {
  translate(width / 2, height / 2)
  scale(1, -1)
  // let s = 10
  let s = height / 10 * .5
  // translate(0, -100)
  // translate(0, -(ymx - ymn)/2 * s)
  translate(0, -5 * s)
  for (let i = 0; i < 10; i ++) {
    // point(x, y)
    point(x * s, y * s)
    ;[x, y] = updatePosition(x, y)
    xmn = min(xmn, x), xmx = max(xmx, x), ymn = min(ymn, y), ymx = max(ymx, y)
  }

  document.querySelector('#pos').innerHTML = `(x, y) = (${x.toFixed(2)}, ${y.toFixed(2)})`
  document.querySelector('#info').innerHTML = `
    #${frameCount} Δ${deltaTime.toFixed(2)}<br>
    x in [${xmn.toFixed(2)}, ${xmx.toFixed(2)}]<br>
    y in [${ymn.toFixed(2)}, ${ymx.toFixed(2)}]
  `
}

function windowResized() {
  resizeCanvas(windowWidth, windowHeight)
  setup()
}
</script>
</body>
</html>